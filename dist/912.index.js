(()=>{var e,t,n={3276:()=>{"object"!=typeof window&&(self.window=self)},1912:(e,t,n)=>{"use strict";n(3276);var r,o=n(6563),s=n(2745);!function(e){e.LOADED="loaded",e.INIT="init",e.READY="ready",e.STATE_UPDATE="stateUpdate",e.MESSAGE_TO_PEER="messageToPeer",e.MESSAGE_FROM_PEER="messageFromPeer",e.PROXY_EVENT="proxyEvent",e.STOP="stop",e.START="start",e.REQUEST="request",e.FORCE_TRIGGER_ELECTION="forceTriggerElectrion",e.EXPORT_SPAN="exportSpan"}(r||(r={}));const a=1e3,i=1500,d=5e3,c=1e4,p=2e4,l=3e3,E=1;var u,m;!function(e){e.FOLLOWER="follower",e.CANDIDATE="candidate",e.LEADER="leader",e.STOPPED="stopped"}(u||(u={})),function(e){e.SENT_MESSAGE="sent message",e.CLEARED_ELECTION_TIMEOUT="cleared election timeout",e.SET_ELECTION_TIMEOUT="set election timeout",e.STARTED_NEW_ELECTION="started new election",e.STEPPED_DOWN="stepped down",e.VOTED="voted",e.RECIEVED_VOTE="recieved vote",e.BECAME_LEADER="became leader",e.RECIEVED_APPEND_ENTRIES="recieved append entries",e.STARTED="started",e.STOPPED="stopped",e.LOG_REQUESTED="log requested"}(m||(m={}));var T=n(6584);class f{constructor(e){this.id=e}export(e,t){return this._sendSpans(e,t)}shutdown(){return this._sendSpans([]),Promise.resolve()}_exportInfo(e){const t=(0,T.hrTimeToMilliseconds)(e.startTime),n=[];e.parentSpanId&&n.push({type:"childOf",spanId:e.parentSpanId,traceId:e.spanContext.traceId}),e.links.forEach((e=>{n.push({type:"followsFrom",spanId:e.context.spanId,traceId:e.context.traceId})}));const r=e.events.map((e=>({timestamp:(0,T.hrTimeToMilliseconds)(e.time),fields:Object.assign(Object.assign({},e.attributes),{name:e.name})}))),o={serviceName:`raft-server-${this.id}`,tags:{}};return{id:e.spanContext.spanId,traceId:e.spanContext.traceId,operationName:e.name,startTime:t,finishTime:t+(0,T.hrTimeToMilliseconds)(e.duration),references:n,tags:e.attributes,logs:r,process:o}}_sendSpans(e,t){for(const t of e){const e={type:r.EXPORT_SPAN,payload:this._exportInfo(t)};self.postMessage(JSON.stringify(e))}if(t)return t({code:T.ExportResultCode.SUCCESS})}}var v=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}d((r=r.apply(e,t||[])).next())}))};let y;const g=e=>new Promise((t=>setTimeout(t,e))),h=a;let O,I,x,S=u.STOPPED,R=1,A=[],P={},_=0,D={},b={};function L(e,t=0){if(!P[e.to])return;const n=a+Math.random()*(i-a);setTimeout((()=>{G({type:r.MESSAGE_TO_PEER,payload:e})}),n),e.type,e.to,G({type:r.PROXY_EVENT,payload:{type:m.SENT_MESSAGE,message:e,delay:n}}),t>0&&(D[e.id]=setTimeout((()=>{delete D[e.id],function(e){const t=b[e.id];if(delete b[e.id],null==t||t.setAttributes({error:"timeout"}),S!=u.STOPPED)return"AppendEntriesResponse"==e.type||"RequestVoteResponse"==e.type?(null==t||t.addEvent("timeout",{messageType:e.type}),void(null==t||t.end())):e.term!=R?(null==t||t.addEvent("timeout",{termChanged:!0,noop:!0}),void(null==t||t.end())):"RequestVote"==e.type&&S==u.CANDIDATE?(null==t||t.addEvent("timeout",{resending:!0}),null==t||t.end(),void j(t,e.to)):void("AppendEntries"==e.type&&S==u.LEADER&&(null==t||t.addEvent("timeout",{resending:!0}),null==t||t.end(),M(t,e.to)));null==t||t.end()}(e)}),t))}function N(e){clearTimeout(x);const t=c+Math.random()*(p-c);x=setTimeout((()=>w(e)),t),null==e||e.addEvent("election-timeout-reset",{timeout:t}),G({type:r.PROXY_EVENT,payload:{type:m.SET_ELECTION_TIMEOUT,delay:t}})}function w(e){return v(this,void 0,void 0,(function*(){if(S!=u.STOPPED&&S!=u.LEADER&&(S==u.CANDIDATE||S==u.FOLLOWER)){const t=o.setSpan(o.context.active(),e),n=y.startSpan("startNewElection",{},t);return n.setAttributes(Object.assign({},V())),N(n),R+=1,O=I,S=u.CANDIDATE,Object.values(P).forEach((e=>{e.voteGranted=!1,e.matchIndex=0,e.nextIndex=1})),q(),G({type:r.PROXY_EVENT,payload:{type:m.STARTED_NEW_ELECTION}}),Object.values(P).forEach((e=>{j(n,e.id)})),yield g(h),void n.end()}}))}function C(e,t){S=u.FOLLOWER,R=t,O=null,N(e),q(),G({type:r.PROXY_EVENT,payload:{type:m.STEPPED_DOWN}})}function j(e,t){const n=y.startSpan("requestVote",{links:[{context:null==e?void 0:e.context()}]}),r={id:X(),from:I,to:t,term:R,type:"RequestVote",lastLogTerm:Y(A,A.length),lastLogIndex:A.length};n.setAttributes({to:t,term:R,lastLogTerm:r.lastLogTerm,lastLogIndex:r.lastLogIndex});const s=o.setSpan(o.context.active(),n);o.propagation.inject(s,r),b[r.id]=n,L(r,d)}function M(e,t){const n=P[t];if(!n)return;const r=y.startSpan("appendEntries",{links:[{context:null==e?void 0:e.context()}]}),s=n.nextIndex-1;let a=Math.min(s+E,A.length);n.matchIndex+1<n.nextIndex&&(a=s);const i={id:X(),from:I,to:t,term:R,type:"AppendEntries",prevIndex:s,prevTerm:Y(A,s),entries:A.slice(s,a),commitIndex:Math.min(_,a)};r.setAttributes({to:t,term:R,prevIndex:i.prevIndex,prevTerm:i.prevTerm,entries:i.entries.map((e=>e.value)).join(","),commitIndex:i.commitIndex});const c=o.setSpan(o.context.active(),r);o.propagation.inject(c,i),b[i.id]=r,L(i,d)}function V(){return{"self.state":S,"self.term":R,"self.votedFor":O,"self.logs":A.map(((e,t)=>e.value)).join(","),"self.logsLength":A.length,"self.commitIndex":_}}function q(){G({type:r.STATE_UPDATE,payload:{state:S,term:R,votedFor:O,log:A,peers:P}})}function G(e){self.postMessage(JSON.stringify(e))}function X(){return Math.random().toString(36).substring(2,7)}function Y(e,t=e.length){return t<1||t>e.length?0:e[t-1].term}self.addEventListener("message",(e=>{const t=JSON.parse(e.data);if(t.type==r.INIT){const{id:e,peerIds:n}=t.payload;I=e,y=o.trace.getTracer(`raft-server-${I}`),n.forEach((e=>{P[e]={id:e,voteGranted:!1,matchIndex:0,nextIndex:1,heartbeatTimeoutId:null}})),function(){const e=new s.BasicTracerProvider;e.addSpanProcessor(new s.SimpleSpanProcessor(new f(I))),e.register()}(),G({type:r.READY})}if(t.type==r.MESSAGE_FROM_PEER){if(clearTimeout(D[t.payload.id]),delete D[t.payload.id],S==u.STOPPED)return;switch(t.payload.type){case"AppendEntries":return function(e){return v(this,void 0,void 0,(function*(){let t=!1,n=0;const s=o.propagation.extract(o.context.active(),e),a=y.startSpan("handleAppendEntries",{},s);if(a.setAttributes(Object.assign(Object.assign({},V()),{"request.term":e.term,"request.prevIndex":e.prevIndex,"request.entries":e.entries,"request.commitIndex":e.commitIndex})),e.type,e.from,R<e.term&&(e.term,a.addEvent("stepping-down",{incomingTerm:e.term,myTerm:R}),C(a,e.term)),R==e.term){if(S=u.FOLLOWER,N(a),0==e.prevIndex||e.prevIndex<=A.length&&Y(A,e.prevIndex)==e.prevTerm){t=!0;let r=e.prevIndex;e.entries.forEach(((e,t)=>{if(r++,Y(A,r)!=e.term){for(;A.length>r-1;)A.pop();A.push(e)}})),n=r,_=Math.max(_,e.commitIndex)}q(),G({type:r.PROXY_EVENT,payload:{type:m.RECIEVED_APPEND_ENTRIES}})}L({id:e.id,from:I,to:e.from,term:R,type:"AppendEntriesResponse",success:t,matchIndex:n}),a.setAttributes({success:t,matchIndex:n}),yield g(h),a.end()}))}(t.payload);case"AppendEntriesResponse":return function(e){const t=b[e.id];delete b[e.id],null==t||t.addEvent("response-recieved",{"response.term":e.term,"response.success":e.success,"response.matchIndex":e.matchIndex}),e.success||null==t||t.setAttributes({error:"not success"}),e.type,e.from,R<e.term&&(e.term,t.addEvent("stepping-down",{incomingTerm:e.term,myTerm:R}),C(t,e.term));const n=e.from;if(S==u.LEADER&&R==e.term){const r=P[n];e.success?(r.matchIndex=Math.max(r.matchIndex,e.matchIndex),r.nextIndex=e.matchIndex+1,function(){const e=[];Object.values(P).forEach((t=>e.push(t.matchIndex))),e.push(A.length),e.sort(((e,t)=>e-t));const t=e[Math.floor((Object.keys(P).length+1)/2)];S==u.LEADER&&Y(A,t)==R&&(_=Math.max(_,t),q())}()):r.nextIndex=Math.max(1,r.nextIndex-1),r.nextIndex<=A.length?(null==t||t.addEvent("logs-missing-resending"),M(t,n)):(null==t||t.addEvent("logs-up-to-date"),clearTimeout(r.heartbeatTimeoutId),r.heartbeatTimeoutId=setTimeout((()=>{S!=u.STOPPED&&S==u.LEADER&&M(t,n)}),l)),q()}null==t||t.end()}(t.payload);case"RequestVote":return function(e){return v(this,void 0,void 0,(function*(){const t=o.propagation.extract(o.context.active(),e),n=y.startSpan("handleRequestVote",{},t);n.setAttributes(Object.assign(Object.assign({},V()),{"request.term":e.term,"request.lastLogTerm":e.lastLogTerm,"request.lastLogIndex":e.lastLogIndex})),e.type,e.from,R<e.term&&(e.term,n.addEvent("stepping-down",{incomingTerm:e.term,myTerm:R}),C(n,e.term));let s=!1;R!=e.term||O&&O!=e.from||!(e.lastLogTerm>Y(A)||e.lastLogTerm==Y(A)&&e.lastLogIndex>=A.length)||(e.from,n.addEvent("voted",{for:e.from}),s=!0,O=e.from,N(n),q(),G({type:r.PROXY_EVENT,payload:{type:m.VOTED}})),L(Object.assign(Object.assign({},e),{from:I,to:e.from,term:R,type:"RequestVoteResponse",granted:s})),n.setAttributes({granted:s}),yield g(h),n.end()}))}(t.payload);case"RequestVoteResponse":return function(e){const t=b[e.id];if(delete b[e.id],null==t||t.addEvent("response-recieved",{"response.term":e.term,"response.granted":e.granted}),e.granted||null==t||t.setAttributes({error:"not granted"}),e.type,e.from,R<e.term&&(e.term,t.addEvent("stepping-down",{incomingTerm:e.term,myTerm:R}),C(t,e.term)),S==u.CANDIDATE&&R==e.term){P[e.from].voteGranted=e.granted,q(),G({type:r.PROXY_EVENT,payload:{type:m.RECIEVED_VOTE}});const n=Math.ceil((Object.keys(P).length+1)/2);let o=1;Object.values(P).forEach((e=>{e.voteGranted&&o++})),o>=n&&(null==t||t.addEvent("become-leader",{grantedVotes:o,quorum:n}),S=u.LEADER,Object.values(P).forEach((e=>{e.nextIndex=A.length+1,M(t,e.id)})),clearTimeout(x),x=null,G({type:r.PROXY_EVENT,payload:{type:m.CLEARED_ELECTION_TIMEOUT}}),q(),G({type:r.PROXY_EVENT,payload:{type:m.BECAME_LEADER}}))}null==t||t.end()}(t.payload)}}t.type==r.START&&function(){v(this,void 0,void 0,(function*(){if(S!=u.STOPPED)return;const e=y.startSpan("start",{});S=u.FOLLOWER,N(e),q(),G({type:r.PROXY_EVENT,payload:{type:m.STARTED}}),yield g(h),e.end()}))}(),t.type==r.STOP&&function(){v(this,void 0,void 0,(function*(){if(S==u.STOPPED)return;const e=y.startSpan("stop",{});S=u.STOPPED,clearTimeout(x),Object.values(P).forEach((e=>{clearTimeout(e.heartbeatTimeoutId)})),q(),G({type:r.PROXY_EVENT,payload:{type:m.STOPPED}}),yield g(h),e.end()}))}(),t.type==r.REQUEST&&function(e){v(this,void 0,void 0,(function*(){const t=y.startSpan("request",{});t.setAttributes(Object.assign(Object.assign({},V()),{value:e})),A.push({term:R,value:e}),q(),G({type:r.PROXY_EVENT,payload:{type:m.LOG_REQUESTED}}),yield g(h),t.end()}))}(t.payload.value),t.type==r.FORCE_TRIGGER_ELECTION&&function(){v(this,void 0,void 0,(function*(){const e=y.startSpan("forceTriggerElection",{});e.setAttributes(Object.assign({},V())),w(e),yield g(h),e.end()}))}()})),G({type:r.LOADED})}},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var s=r[e]={id:e,loaded:!1,exports:{}};return n[e].call(s.exports,s,s.exports,o),s.loaded=!0,s.exports}o.m=n,o.x=()=>{var e=o.O(void 0,[745],(()=>o(1912)));return o.O(e)},e=[],o.O=(t,n,r,s)=>{if(!n){var a=1/0;for(c=0;c<e.length;c++){for(var[n,r,s]=e[c],i=!0,d=0;d<n.length;d++)(!1&s||a>=s)&&Object.keys(o.O).every((e=>o.O[e](n[d])))?n.splice(d--,1):(i=!1,s<a&&(a=s));i&&(e.splice(c--,1),t=r())}return t}s=s||0;for(var c=e.length;c>0&&e[c-1][2]>s;c--)e[c]=e[c-1];e[c]=[n,r,s]},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,n)=>(o.f[n](e,t),t)),[])),o.u=e=>e+".index.js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={912:1};o.f.i=(t,n)=>{e[t]||importScripts(o.p+o.u(t))};var t=self.webpackChunkstalk_demo_raft_consensus=self.webpackChunkstalk_demo_raft_consensus||[],n=t.push.bind(t);t.push=t=>{var[r,s,a]=t;for(var i in s)o.o(s,i)&&(o.m[i]=s[i]);for(a&&a(o);r.length;)e[r.pop()]=1;n(t)}})(),t=o.x,o.x=()=>o.e(745).then(t),o.x()})();
//# sourceMappingURL=912.index.js.map